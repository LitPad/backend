# Use an official Golang runtime as a parent image
FROM golang:1.22.1-alpine3.18

# Install wget and other dependencies
RUN apk add --no-cache wget bash

# Create a directory for your app
RUN mkdir build

# Set the working directory
WORKDIR /build

# Copy go.mod and go.sum to download dependencies
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy the source code
COPY . .

# Expose the port your app runs on
EXPOSE 8000

# Build the Go Fiber application
RUN go build -tags netgo -ldflags '-s -w' -o app

# Install siad
RUN wget -O sia.tar.gz https://sia.tech/releases/Sia-v1.5.6-linux-amd64.tar.gz && \
    tar -xzvf sia.tar.gz && \
    mv Sia-v1.5.6-linux-amd64/siad /usr/local/bin/ && \
    mv Sia-v1.5.6-linux-amd64/siac /usr/local/bin/ && \
    rm -rf sia.tar.gz Sia-v1.5.6-linux-amd64

# Start both siad and the Go Fiber app
CMD ["sh", "-c", "siad --authenticate-api=\"my_secure_password\" & ./app"]
